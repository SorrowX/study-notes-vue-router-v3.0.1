<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>navigation-guards</title>
</head>
<body>
	<div id="app"></div>
	<script src="../../dist/vue.js"></script>
	<script src="../../dist/vue-router.js"></script>
	<script>
		const Home = { template: '<div>home</div>' }
		const Foo = { 
			template: '<div>foo</div>',
			beforeRouteEnter (to, from, next) {
			    console.log('在渲染该组件的对应路由被 confirm 前调用')
			},
			beforeRouteUpdate (to, from, next) {
			    console.log('在当前路由改变，但是该组件被复用时调用')
			},
			beforeRouteLeave (to, from, next) {
			    console.log('导航离开该组件的对应路由时调用')
			}
		}
		const Bar = { 
			template: '<div>bar</div>',
			beforeRouteEnter (to, from, next) {
			    console.log('在渲染该组件的对应路由被 confirm 前调用')
			},
			beforeRouteUpdate (to, from, next) {
			    console.log('在当前路由改变，但是该组件被复用时调用')
			},
			beforeRouteLeave (to, from, next) {
			    console.log('导航离开该组件的对应路由时调用')
			}
		}

		const Baz = {
			data() {
				return {
					saved: false
				}
			},
			template: `
			    <div>
			        <p>baz ({{ saved ? 'saved' : 'not saved' }})</p>
			        <button @click="saved = true">save</button>
			    </div>
			`,
			beforeRouteEnter (to, from, next) {
			    // 在渲染该组件的对应路由被 confirm 前调用
			    // 不！能！获取组件实例 `this`
			    // 因为当守卫执行前，组件实例还没被创建
			    console.log('在渲染该组件的对应路由被 confirm 前调用')
			},
			beforeRouteUpdate (to, from, next) {
			    // 在当前路由改变，但是该组件被复用时调用
			    // 举例来说，对于一个带有动态参数的路径 /foo/:id，在 /foo/1 和 /foo/2 之间跳转的时候，
			    // 由于会渲染同样的 Foo 组件，因此组件实例会被复用。而这个钩子就会在这个情况下被调用。
			    // 可以访问组件实例 `this`
			    console.log('在当前路由改变，但是该组件被复用时调用')
			},
			beforeRouteLeave (to, from, next) {
			    // 导航离开该组件的对应路由时调用
			    // 可以访问组件实例 `this`
			    console.log('导航离开该组件的对应路由时调用')
				if (this.saved || window.confirm('未保存,确定要离开该页面?')) {
					next()
				} else {
					next(false)
				}
			}
		}

		const Qux = {
			data() {
				return {
					msg: null
				}
			},
			template: `
				<div>{{ msg }}</div>
			`,
			beforeRouteEnter(to, from, next) {
				console.log('beforeRouteEnter')
				setTimeout(() => {
					next(vm => {
						vm.msg = 'Qux'
					})
				}, 300)
			}
		}

		const Quux = {
			data() {
				return {
                    prevId: 0
				}
			},
			template: `
				<div>
				    id:{{ $route.params.id }} 
				    prevId:{{ prevId }}
				</div>
			`,
			beforeRouteUpdate(to, from, next) {
                this.prevId = from.params.id
			    next()
			}
		}

		let router = new VueRouter({
			routes: [
                {
                	path: '/',
                	component: Home
                },
                {
                	path: '/foo',
                	component: Foo,
                	beforeEnter: guardRoute
                },
                {
                	path: '/bar',
                	component: Bar,
                	meta: {
                		needGuard: true
                	}
                },
                {
                	path: '/baz',
                	component: Baz
                },
                {
                	path: '/qux-async',
                	component: resolve => {
                        setTimeout(() => {
                        	resolve(Qux)
                        }, 0)
                	}
                },
                {
                	path: '/qux',
                	component: Qux
                },
                {
                	path: '/quux/:id',
                	component: Quux
                }
			]
		})

		router.beforeEach((to, from, next) => {
			console.log('beforeEach')
			if (to.matched.some(m => m.meta.needGuard)) {
				guardRoute(to, from, next)
			} else {
				next()
			}
		})

		function guardRoute(to, from, next) {
			if (window.confirm(`Navigate to ${to.path}?`)) {
				next()
			} else if (window.confirm(`Redirect to /baz?`)) {
				next('/baz')
			} else {
				next(false)
			}
		}

		new Vue({
			router,
			template: `
			    <div id="app">
			        <h3>Navigation Guards</h3>
			        <ul>
			            <li><router-link to="/">/</router-link></li>
			            <li><router-link to="/foo">/foo</router-link></li>
			            <li><router-link to="/bar">/bar</router-link></li>
			            <li><router-link to="/baz">/baz</router-link></li>
			            <li><router-link to="/qux">/qux</router-link></li>
			            <li><router-link to="/qux-async">/qux-async</router-link></li>
			            <li><router-link to="/quux/1">/quux/1</router-link></li>
				        <li><router-link to="/quux/2">/quux/2</router-link></li>
			        </ul>
			        <router-view class="view"></router-view>
			    </div>
			`
		}).$mount('#app')
	</script>
</body>
</html>