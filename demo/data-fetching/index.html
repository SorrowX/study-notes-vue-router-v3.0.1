<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>data-fetching</title>
	<style type="text/css">
		.loading {
		    position: absolute;
		    top: 10px;
		    right: 10px;
		}
		.error {
		    color: red;
		}
		.content {
		    transition: all .35s ease;
		    position: absolute;
		}
		.slide-enter {
		    opacity: 0;
		    transform: translate(30px, 0);
		}
		.slide-leave-active {
		    opacity: 0;
		    transform: translate(-30px, 0);
		}
	</style>
</head>
<body>
	<div id="app"></div>
	<script src="../../dist/vue.js"></script>
	<script src="../../dist/vue-router.js"></script>
	<script>

		// api
		const posts = {
		    '1': {
			    id: 1,
			    title: 'sunt aut facere',
			    body: 'quia et suscipit suscipit recusandae consequuntur expedita et cum reprehenderit molestiae ut ut quas totam nostrum rerum est autem sunt rem eveniet architecto'
		    },
		    '2': {
			    id: 2,
			    title: 'qui est esse',
			    body: 'est rerum tempore vitae sequi sint nihil reprehenderit dolor beatae ea dolores neque fugiat blanditiis voluptate porro vel nihil molestiae ut reiciendis qui aperiam non debitis possimus qui neque nisi nulla'
		    }
		}

		function getPost (id, cb) {
		    setTimeout(() => {
			    if (posts[id]) {
			        cb(null, posts[id])
			    } else {
			        cb(new Error('Post not found.'))
			    }
		    }, 100)
		}

		// post组件
		let Post = {
			data() {
				return {
					loading: false,
					post: null,
				    error: null
				}
			},
			created() {
                this.fetchData()
			},
			watch: {
				'$route': 'fetchData'
			},
			methods: {
				fetchData(to, from) {
					console.log(to, from)
                    this.post = this.error = null
                    this.loading = true
                    getPost(this.$route.params.id, (err, post) => {
                    	this.loading = false
                    	if (err) {
                    		this.error = err.toString()
                    	} else {
                    		this.post = post
                    	}
                    })
				}
			},
			template: `
			    <div class="post">
			        <div class="loading" v-if="loading"> Loading... </div>
			        <div class="error" v-if="error"> {{ error }} </div>
			        <transition name="slide">
			            <div class="content" v-if="post" :key="post.id">
			                <h2> {{ post.title }} </h2>
			                <p> {{ post.body }} </p>
			            </div>
			        </transition>
			    </div>
			`
		}

        // app
        const Home = { template: '<div class="home">home</div>' }

        let router = new VueRouter({
        	routes: [
        	    {
        	    	path: '/',
        	    	component: Home
        	    },
        	    {
        	    	path: '/post/:id',
        	    	component: Post
        	    }
        	]
        })

		let res = Vue.compile(`
            <div id="app">
                <h3>Data Fetching</h3>
                <ul>
                    <li>
                        <router-link to="/"> / </router-link>
                    </li>
                    <li>
                        <router-link to="/post/1"> /post/1 </router-link>
                    </li>
                    <li>
                        <router-link to="/post/2"> /post/2 </router-link>
                    </li>
                    <li>
                        <router-link to="/post/3"> /post/3 </router-link>
                    </li>
                </ul>
                <router-view class="view"></router-view>
            </div>
		`)

		let vm = new Vue({
			router,
			render: res.render,
			staticRenderFns: res.staticRenderFns
		}).$mount('#app')
	</script>
</body>
</html>